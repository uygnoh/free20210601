############################################################
### % DS1302
############################################################
% DS1302是美国DALLAS公司推出的一种高性能，低功耗的实时时钟芯片。
1 % 附加“31”字节静态RAM
2 % 采用SPI三线接口与CPU进行通信
3 % 可提供秒，分， 时， 日，星期，月， 年
4 % 一个月小于“31”天时可以自动高速，且具有闰年补偿功能
4 % 工作电压为： 2.5~5.5V
5 % 采用双电源供电(主电源和备用电源)


############################################################
### % DS1302引脚功能
############################################################
Pin_8   Vcc1        % 备用电池端
Pin_1   Vcc2        % 5V电源。 当 “Vcc2 > Vcc1+0.2”时，由Vcc2向
                    % DS1302供电。“Vcc2 < Vcc1”时，由Vcc1向DS1302供电
                    
Pin_7   SCLK        % 串行时钟，输入
Pin_6   I/O         % 数据输入输出端口
Pin_5   CE/RST      % 复位引脚

Pin_4   GND
Pin_3   x2          % 外接晶振引脚
Pin_2   x1          % 外接晶振引脚(32.768KHz)



############################################################
### % DS1302控制字
############################################################
________________________________________________
7     6        5   4   3   2   1       0
1   RAM/CK     A4  A3  A2  A1  A0    RD/WR
________________________________________________
bit7    % 最高有效位，必须为“1”
bit6    % 为“0”表示存取日历时钟数据，为“1”表示存取RAM数据
5:1     % 指示操作单元的地址
bit0    % 为“0”表示要进行写操作，为“1”表示要进行读操作

% 读数据，下降沿
读数据进在紧跟“8”位控制字指令后的下一个SCLK脉冲的下降沿，读出
DS1302中的数据，读出的数据是从最低位到最高位。
% 写数据，上升沿
控制字总是从最低位开始输出。在控制字指令输入后的下一个SCLK时钟的
上升沿时，数据被写入DS1320，数据输入也是从最低位开始。



############################################################
### 
############################################################
#include <reg51.h>
#include <intrins.h>

sbit IO     = P3^3
sbit SCLK   = P3^4
sbit RST    = P3^5

unsigned char flag, second, minute, hour, week, day, month, year;


/* 向DS1302写入一个字节 */
void ds1302_write_byte(uint8_t dat)
{
    uint8_t i;
    SCLK = 0;
    delay_us();
    
    for (i = 8; i > 0; i--)
    {                       //数据从最低位开始传送
        IO = dat & 0x01;    //先把数据准备好
        delay_us(5);        //稍作延时
        SCLK = 1;           //为写入数据制造上升沿
        delay_us(5);        //稍作延时，写入数据
        SCLK = 0;           //为下一次上升没写入下一个数据作准备
        dat >>= 1;          //将数据向右移“1”位，准备写入下一个数据
    }
}



/* 向DS1302中读取一个字节 */
uint8_t ds1302_read_byte(void)
{
    uint8_t i, dat;
    delay_us(5);
    
    for (i = 8; i > 0; i--)
    {                       //数据从低位开始读取
        dat >>= 1;          //把要读取的位存储在dat中
        if (IO == 1)        //判断IO端口上的数据
            dat |= 0x80;    //存储IO端口上的数据存储dat中
        SCLK = 1;           //把SCLK拉高，为读一个位作准备
        delay_us(5);        //稍作延时，制造一个高电平
        SCLK = 0;           //为读取一个位制造下降沿
        delay_us(5);        //稍作延时
    }
    
    return dat;
}














